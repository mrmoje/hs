---
- name: install mysql config file that binds to management network interface
  template:
    src: my.cnf
    dest: /etc/mysql/my.cnf
    owner: root
    group: root
    mode: 0644

- name: ensure mysql is started and enabled
  service:
    name: mysql
    state: restarted
    enabled: yes

- name: update mysql root password for all root accounts
  mysql_user:
    name: root
    host: localhost
    password: "{{ mysql_root_password }}"
    state: present

# Need to do this for idempotency, see
# http://ansible.cc/docs/modules.html#mysql-user
- name: copy .my.cnf file with root password credentials
  template:
    src: root.my.cnf
    dest: /root/.my.cnf
    owner: root
    group: root
    mode: 0600

- name: update mysql root password for all root accounts
  mysql_user:
    name: root
    host: "{{ item }}"
    password: "{{ mysql_root_password }}"
    priv: "*.*:ALL,GRANT"
    state: present
  with_items:
    - "{{ ansible_hostname }}"
    - "{{ inventory_hostname }}"
    - 127.0.0.1
    - ::1

- name: ensure anonymous users are not in the database
  mysql_user:
    name: ""
    host: "{{ item }}"
    state: absent
  with_items:
    - "{{ ansible_hostname }}"
    - "{{ inventory_hostname }}"
    - localhost
    - 127.0.0.1
    - ::1
    - "%"

- name: delete anonymous MySQL server user for localhost
  mysql_user:
    user: ""
    state: "absent"

- name: remove the MySQL test database
  mysql_db:
    db: "test"
    state: "absent"
