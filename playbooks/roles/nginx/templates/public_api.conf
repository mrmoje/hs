{% for upstream in api_upstreams %}
upstream {{ upstream['name'] }} {
  server {{ controller_endpoint_host }}:{{ upstream['port'] }};
}

{% endfor %}

server {
  listen {{ public_api_address }}:80;

  access_log /var/log/nginx/api.access.log;
  error_log /var/log/nginx/api.error.log;

  client_max_body_size 0;
  underscores_in_headers on;

  proxy_read_timeout 300s;
{% for location in api_locations %}

  location {{ location['pattern'] }} {
{% if location['rewrite'] != "" %}
    rewrite {{ location['rewrite'] }} break;
{% endif %}
    proxy_pass http://{{ location['upstream'] }};
  }
{% endfor %}

  location / {
    return 404;
  }
}
